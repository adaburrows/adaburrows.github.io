<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Make sure it builds under Rosetta"><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="How to ensure all of Nix works on Apple silicon"><meta property="og:description" content="Make sure it builds under Rosetta"><meta property="og:type" content="article"><meta property="og:url" content="http://adaburrows.com/writing/2022-09-02-nix-rosetta-fix/"><meta property="og:image" content="http://adaburrows.com/writing/2022-09-02-nix-rosetta-fix/images/holonix-compile.png"><meta property="article:section" content="writing"><meta property="article:published_time" content="2022-09-02T00:00:00+00:00"><meta property="article:modified_time" content="2022-09-06T23:21:05-07:00"><title>How to ensure all of Nix works on Apple silicon | Jillian Ada Burrows</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.b5176eb0ca2cd8435f2fe099b1d858f5676ab2cb70001398eb62e5fa2bb99977.css integrity="sha256-tRdusMos2ENfL+CZsdhY9WdqsstwABOY62Ll+iu5mXc="><script defer src=/en.search.min.7b90c13b4b54430f17685e2c4e7e503f2b56b17f7551894f267fd563193a313a.js integrity="sha256-e5DBO0tUQw8XaF4sTn5QPytWsX91UYlPJn/VYxk6MTo="></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-148152323-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script><meta name=monetization content="$ilp.uphold.com/fejEUG7Beey6"></head><body><input type=checkbox class=hidden id=menu-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=/><span>Jillian Ada Burrows</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/docs/resume/>Resume</a><ul></ul></li><li><a href=/docs/ice-age/>Ice Age Map</a></li><li><a href=/docs/narrative-culture/ class=collapsed>The Emergence of Culture</a></li><li><a href=/docs/nkp/ class=collapsed>A Matter of Programming</a></li><li><a href=/docs/math-explorations/ class=collapsed>Math Explorations</a></li></ul><ul><li><a href=/writing/>Writing</a></li><li><a href=/support-me/>Support My Work</a></li></ul><br><ul class=social><li><a rel=me href=https://instagram.com/adaburrows><i class="fab fa-instagram"></i>&nbsp;Instagram</a></li><li><a rel=me href=https://www.facebook.com/jillburrows.writer/><i class="fab fa-facebook-square"></i>&nbsp;Facebook</a></li><li><a rel=me href=https://twitter.com/jburrows><i class="fab fa-twitter-square"></i>&nbsp;Twitter</a></li><li><a rel=me href=https://www.linkedin.com/in/adaburrows/><i class="fab fa-linkedin"></i>&nbsp;Linkedin</a></li><li><a href=https://t.me/adaburrows><i class="fab fa-telegram"></i>&nbsp;Telegram</a></li><li><a href=https://discord.gg/mgtQBHV><i class="fab fa-discord"></i>&nbsp;Discord</a></li><li><a rel=me href=https://github.com/adaburrows/><i class="fab fa-github-square"></i>&nbsp;Github</a></li></ul></nav><script>(function(){var e=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>How to ensure all of Nix works on Apple silicon</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><input type=checkbox class=hidden id=toc-control><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#the-situation>The Situation</a></li><li><a href=#remove-the-existing-nix-install>Remove the existing Nix install</a></li><li><a href=#restart>Restart</a></li><li><a href=#make-a-copy-of-terminal-that-runs-under-rosetta>Make a copy of Terminal that runs under Rosetta</a></li><li><a href=#reinstall-nix-in-this-new-terminal>Reinstall Nix in this new terminal</a></li><li><a href=#use-nix-from-any-terminal>Use Nix from any terminal</a></li><li><a href=#updates-on-the-original-problem>Updates on the original problem</a></li></ul></nav></aside></header><article class=markdown><h1><a href=/writing/2022-09-02-nix-rosetta-fix/>How to ensure all of Nix works on Apple silicon</a></h1><h5>September 2, 2022</h5><p><figure><a href=images/holonix-compile.png><img src=images/holonix-compile.png alt="Compiling Holochain on Holonix running in Rosetta."></a><figcaption><p>Compiling Holochain on Holonix running in Rosetta.</p></figcaption></figure><h2 id=the-situation>The Situation
<a class=anchor href=#the-situation>#</a></h2><p>When I first got my new M1 based computer, there were some time limitations on getting my dev environment set up. I was developing <a href=https://github.com/lightningrodlabs/rea-playspace>a Holochain project using Holonix</a> (a Nix based environment) to get all of the required binaries set up. I timeboxed myself to a maximum of four hours, and ended up getting stuck when compiling the <a href=https://github.com/nmattia/niv>Niv dependency manager for Nix</a>. When I compiled it natively there was a filesystem cycle that Nix did not like and it would just abort (there may be a quick patch for the compiler that could fix this, but I haven&rsquo;t seen it).</p><p>I gave up after following a few different &ldquo;How-to&rdquo; guides that all ended it the same pain. I ended up installing the Holochain tools manually, which worked until Holochain 0.0.47, but I lost track of the dependencies after the upgrade to the version including Holochain Deterministic Integrity. So I bought an Intel based Mac to not lose more time.</p><p>As I recently learned from a new friend, there&rsquo;s a small detail which must be observed: the terminal emulator used to install Nix must be running in Rosetta when installing Nix.</p><p>Unfortunately, if you&rsquo;ve already installed Nix natively, you need to remove it and reinstall it.</p><h2 id=remove-the-existing-nix-install>Remove the existing Nix install
<a class=anchor href=#remove-the-existing-nix-install>#</a></h2><p>Either edit or restore the system shell rc files.</p><ul><li>Edit and remove the loader code from both zshrc and bashrc:<pre tabindex=0><code>❯ sudo vim /etc/zshrc
❯ sudo vim /etc/bashrc
❯ sudo rm /etc/*.backup-before-nix
</code></pre></li><li>If no other changes have been made to your rc files since installation, you may restore from backup:<pre tabindex=0><code>sudo mv /etc/zshrc.backup-before-nix /etc/zshrc
sudo mv /etc/bashrc.backup-before-nix /etc/bashrc
</code></pre></li></ul><p>Remove the disk from the fstab:</p><pre tabindex=0><code>❯ sudo vifs
❯ cat /etc/synthetic.conf
nix
</code></pre><p>If there is only one item listed in <code>/etc/synthetic.conf</code>, then just <code>rm</code> it:</p><pre tabindex=0><code>❯ sudo rm /etc/synthetic.conf
</code></pre><p>If there are more items, edit it and remove the line with <code>nix</code>:</p><pre tabindex=0><code>❯ sudo vim /etc/synthetic.conf
</code></pre><p>Remove the services:</p><pre tabindex=0><code>❯ sudo launchctl unload /Library/LaunchDaemons/org.nixos.nix-daemon.plist
❯ sudo rm /Library/LaunchDaemons/org.nixos.nix-daemon.plist
❯ sudo launchctl unload /Library/LaunchDaemons/org.nixos.darwin-store.plist
❯ sudo rm /Library/LaunchDaemons/org.nixos.darwin-store.plist
</code></pre><p>Clean up the Groups, Users, and Volume:</p><pre tabindex=0><code>❯ sudo rm -rf /etc/nix /var/root/.nix-profile /var/root/.nix-defexpr /var/root/.nix-channels ~/.nix-profile ~/.nix-defexpr ~/.nix-channels
❯ sudo dscl . delete /Groups/nixbld
❯ for i in $(seq 1 32); do sudo dscl . -delete /Users/_nixbld$i; done
❯ sudo diskutil apfs deleteVolume /nix
Started APFS operation
Deleting APFS Volume from its APFS Container
Unmounting disk3s7
Erasing any xART session referenced by 59272A91-D4FE-4F12-B832-51E00C186075
Deleting Volume
Removing any Preboot and Recovery Directories
Finished APFS operation
</code></pre><h2 id=restart>Restart
<a class=anchor href=#restart>#</a></h2><pre tabindex=0><code>❯ sudo shutdown -r now
</code></pre><p>Then remove <code>/nix</code>:</p><pre tabindex=0><code>❯ sudo rm -rf /nix/
</code></pre><h2 id=make-a-copy-of-terminal-that-runs-under-rosetta>Make a copy of Terminal that runs under Rosetta
<a class=anchor href=#make-a-copy-of-terminal-that-runs-under-rosetta>#</a></h2><ul><li>In a finder window, navigate to the folder that contains Terminal.</li><li>Control-click on Terminal and click <code>Duplicate</code>.</li><li>Rename the duplicate app to <code>Terminal (Rosetta)</code>.</li><li>Control-click and select <code>Get Info</code>.</li><li>Under <code>General</code>, make sure <code>Open with Rosetta</code> is selected.</li></ul><p><em>Note</em>: This also works with iTerm or any other universal binary terminal emulator.</p><p>It&rsquo;s also possible to use the command line or script to run the shell without making a separate copy. See &lsquo;<a href=https://stackoverflow.com/questions/71065636/how-can-i-run-a-command-or-script-in-rosetta-from-terminal-on-m1-mac>How can I run a command or script in rosetta from terminal on M1 Mac?</a>&rsquo;.</p><h2 id=reinstall-nix-in-this-new-terminal>Reinstall Nix in this new terminal
<a class=anchor href=#reinstall-nix-in-this-new-terminal>#</a></h2><p>You can verify the architecture:</p><pre tabindex=0><code>❯ arch
i386
</code></pre><p>Then follow the install instructions on the Nix install page again.</p><ul><li><a href=https://nixos.org/download.html#nix-install-macos>Nix: the package manager</a></li></ul><h2 id=use-nix-from-any-terminal>Use Nix from any terminal
<a class=anchor href=#use-nix-from-any-terminal>#</a></h2><p>Once Nix is installed and bootstrapped, every executable it builds should be using the Intel architecture running on Rosetta. This means you can use any terminal you want. it doesn&rsquo;t need to be running on Rosetta.</p><h2 id=updates-on-the-original-problem>Updates on the original problem
<a class=anchor href=#updates-on-the-original-problem>#</a></h2><p><em>[added on 2022/9/6. -JB]</em></p><p><em>TLDR; as of 2022/9/1 the <code>unstable</code> channel should work out of the box. But I haven&rsquo;t taken the time to test it, now that I have a working system.</em></p><p>The core of the problem was the cycle in the filesystem that threw Nix for a loop. There are several tickets on github that happen to deal with this. The relevant aspects of this process seem to be merged in. The fun is seeing if the nixpkgs have been updated to include these fixes.</p><ul><li><a href=https://github.com/NixOS/nixpkgs/issues/140774>haskell packages with separate bin outputs fail due to a reference cycle on aarch64-darwin #140774</a></li><li><a href=https://github.com/NixOS/nixpkgs/pull/154046>ghc8107: fix seperate bin outputs on aarch64-darwin #154046</a></li><li><a href=https://github.com/NixOS/nixpkgs/pull/167895>haskell.compiler.ghc902: fix seperate bin outputs on aarch64-darwin #167895</a></li><li><a href=https://github.com/NixOS/nixpkgs/pull/184041>Add cabal-paths patch for ghc 9.2.3 #184041</a></li></ul><p>Digging through through the nixpkgs for Haskell, and it turns out that in in channel <a href=https://raw.githubusercontent.com/NixOS/nixpkgs/nixos-22.05/pkgs/development/haskell-modules/hackage-packages.nix><code>22.05</code></a> it still uses ghc 9.2.2, which does not have the correct fixes. Whereas in <a href=https://raw.githubusercontent.com/NixOS/nixpkgs/nixos-unstable/pkgs/development/haskell-modules/hackage-packages.nix><code>unstable</code></a> it uses ghc 9.2.4, which does have the correct fixes.</p><p>These updates were merged into master Monday, 29 August:</p><pre tabindex=0><code>ab0f52080fd - Merge pull request #187575 from NixOS/haskell-updates (9 days ago) &lt;Ellie Hermaszewska&gt;
214c9d5cef4 - Merge pull request #184194 from NixOS/haskell-updates (5 weeks ago) &lt;sternenseemann&gt;
7f909b041b9 - haskell.compiler: ghc923 -&gt; ghc924 (6 weeks ago) &lt;sternenseemann&gt;
</code></pre><p>Looking at the <code>nixpkgs-unstable</code> branch, it was last cut on Thursday, 1 September — which is just a few days after I last tried this excercise.</p><pre tabindex=0><code>2da64a81275 - (origin/nixos-unstable, nixos-unstable) Merge #188383: ngtcp2-gnutls: init at 0.7.0 and use in knot-dns (6 days ago) &lt;Vladimír Čunát&gt;
</code></pre><p>This means, going forward, everything in my blog post should not be required. If you&rsquo;re running the most recent <code>unstable</code> channel it should actually just work out of the box. It looks like this should all be in the next stable release, too.</p></p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/adaburrows/adaburrows.github.io/commit/e1ffa68f94dc5da2f7983bed432aeafe25cb340d title='Last modified by Jillian Ada Burrows | September 7, 2022' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt=Calendar>
<span>September 7, 2022</span></a></div></div><p><i class="fas fa-recycle"></i>&nbsp;Please remember to recycle this page. <i class="fas fa-radiation"></i>&nbsp;<a style=color:#000 href=https://www.nj.gov/llrwsb/radwrld.htm>May contain trace amounts of radioactive materials.</a> <i class="fas fa-hands-wash"></i>&nbsp;Don't forget to wash your hands. <i class="fas fa-transgender-alt"></i>&nbsp;<a style=color:#000 href=https://transequality.org/issues/resources/supporting-the-transgender-people-in-your-life-a-guide-to-being-a-good-ally>Support your friendly trans people.</a> <a style=color:#000 href=https://blacklivesmatter.com/>#BlackLivesMatter</a> <a style=color:#000 href=https://resourcegeneration.org/land-reparations-indigenous-solidarity-action-guide/>#LandBack</a> <a style=color:#000 href=https://news.umiamihealth.org/en/your-questions-about-cloth-face-coverings-answered/>#MasksSaveLives</a></p></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#the-situation>The Situation</a></li><li><a href=#remove-the-existing-nix-install>Remove the existing Nix install</a></li><li><a href=#restart>Restart</a></li><li><a href=#make-a-copy-of-terminal-that-runs-under-rosetta>Make a copy of Terminal that runs under Rosetta</a></li><li><a href=#reinstall-nix-in-this-new-terminal>Reinstall Nix in this new terminal</a></li><li><a href=#use-nix-from-any-terminal>Use Nix from any terminal</a></li><li><a href=#updates-on-the-original-problem>Updates on the original problem</a></li></ul></nav></aside></main></body></html>